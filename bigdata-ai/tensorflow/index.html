<!doctype html><html lang=zh class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.65.3"><meta name=description content="腾讯云容器服务"><meta name=author content="腾讯云容器架构师团队"><link rel=icon href=/images/favicon.png type=image/png><title>TensorFlow on TKE/EKS</title><script>window.algoliaAppID='B6Q6PSGUV5';window.algoliaKey='5b4678e9995fe4211c4fa43ad2ffdab5';window.algoliaIndex='kubetencent-book-zh';</script><script src=https://kubetencent-1251707795.cos.accelerate.myqcloud.com/js/bundle.min.8d534562810f42a5942ec72a0b7ae599c8bf0c96a4c8d6fafffa9bf21fce9d77.js></script><link rel=stylesheet href=https://kubetencent-1251707795.cos.accelerate.myqcloud.com/css/bundle.min.b0e6163350b1169d986890f4bd317db6286105863b7a53274abdb5c8d935eaa1.css><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/bigdata-ai/tensorflow/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=https://book.kubetencent.io style=display:block><div style=width:100%;height:100%><img src=https://res.cloudinary.com/imroc/image/upload/c_scale,w_64/v1583293443/kubernetes-practice-guide/img/kubernetes.png><div style=height:100%;margin-bottom:3px;font-weight:700>腾讯云容器服务指南</div></div></a></div><div class=aa-input-container id=aa-input-container><input type=search id=aa-search-input class=aa-input-search placeholder=搜索... name=search autocomplete=off><svg class="aa-input-icon" viewBox="654 -372 1664 1664"><path d="M1806 332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2 1481.3-116 1358-116s-228.8 43.8-316.5 131.5S910 208.7 910 332s43.8 228.8 131.5 316.5S1234.7 780 1358 780s228.8-43.8 316.5-131.5S1806 455.3 1806 332zm512 832c0 34.7-12.7 64.7-38 90s-55.3 38-90 38c-36 0-66-12.7-90-38l-343-342c-119.3 82.7-252.3 124-399 124-95.3.0-186.5-18.5-273.5-55.5s-162-87-225-150-113-138-150-225S654 427.3 654 332s18.5-186.5 55.5-273.5 87-162 150-225 138-113 225-150S1262.7-372 1358-372s186.5 18.5 273.5 55.5 162 87 225 150 113 138 150 225S2062 236.7 2062 332c0 146.7-41.3 279.7-124 399l343 343C2305.7 1098.7 2318 1128.7 2318 1164z" /></svg></div><script type=text/javascript>var baseurl="https:\/\/book.kubetencent.io";</script></div><div class=highlightable><ul class=topics><li data-nav-id=/intro/ title=产品指引 class=dd-item><a href=/intro/>产品指引
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/intro/tke/ title=TKE class=dd-item><a href=/intro/tke/>TKE
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/intro/eks/ title=EKS class=dd-item><a href=/intro/eks/>EKS
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/intro/tke-mesh/ title="TKE Mesh" class=dd-item><a href=/intro/tke-mesh/>TKE Mesh
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/intro/tcr/ title=TCR class=dd-item><a href=/intro/tcr/>TCR
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/intro/changelog/ title=更新历史 class=dd-item><a href=/intro/changelog/>更新历史
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/network/ title=集群网络 class=dd-item><a href=/network/>集群网络
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/network/understand-cluster-networking/ title=彻底理解集群网络 class=dd-item><a href=/network/understand-cluster-networking/>彻底理解集群网络
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/network/tke-networking/ title="TKE 集群网络介绍" class=dd-item><a href=/network/tke-networking/>TKE 集群网络介绍
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/network/analysis-cidr/ title="网络划分与最大节点/service/pod 的数量" class=dd-item><a href=/network/analysis-cidr/>网络划分与最大节点/service/pod 的数量
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/network/container-route/ title=容器路由互通 class=dd-item><a href=/network/container-route/>容器路由互通
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/ingress/ title=Ingress class=dd-item><a href=/ingress/>Ingress
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/ingress/understand-ingress/ title="彻底理解 Ingress" class=dd-item><a href=/ingress/understand-ingress/>彻底理解 Ingress
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/ingress/choose-ingress/ title="Ingress 方案选型" class=dd-item><a href=/ingress/choose-ingress/>Ingress 方案选型
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/ingress/tke-ingress/ title="TKE Ingress" class=dd-item><a href=/ingress/tke-ingress/>TKE Ingress
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/ingress/other/ title="开源 Ingress 方案" class=dd-item><a href=/ingress/other/>开源 Ingress 方案
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/ingress/other/nginx-ingress/ title="Nginx Ingress on TKE" class=dd-item><a href=/ingress/other/nginx-ingress/>Nginx Ingress on TKE
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/ingress/other/traefik-ingress/ title="Traefik Ingress on TKE" class=dd-item><a href=/ingress/other/traefik-ingress/>Traefik Ingress on TKE
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li><li data-nav-id=/storage/ title=存储 class=dd-item><a href=/storage/>存储
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/andon/ title=附加组件 class=dd-item><a href=/andon/>附加组件
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/andon/install-metrics-server-on-tke/ title="在 TKE 中安装 metrics-server" class=dd-item><a href=/andon/install-metrics-server-on-tke/>在 TKE 中安装 metrics-server
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/monitoring/ title=监控告警 class=dd-item><a href=/monitoring/>监控告警
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/monitoring/deploy-prometheus-on-tke/ title="在 TKE 上搭建 Prometheus 监控系统" class=dd-item><a href=/monitoring/deploy-prometheus-on-tke/>在 TKE 上搭建 Prometheus 监控系统
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/log/ title=日志搜集 class=dd-item><a href=/log/>日志搜集
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/cicd/ title=CI/CD class=dd-item><a href=/cicd/>CI/CD
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/bigdata-ai/ title="大数据与 AI" class="dd-item
parent"><a href=/bigdata-ai/>大数据与 AI
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/bigdata-ai/gpu-share/ title="GPU 虚拟化" class=dd-item><a href=/bigdata-ai/gpu-share/>GPU 虚拟化
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/bigdata-ai/flink/ title=Flink class=dd-item><a href=/bigdata-ai/flink/>Flink
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/bigdata-ai/flink/intro/ title="Flink 介绍" class=dd-item><a href=/bigdata-ai/flink/intro/>Flink 介绍
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/bigdata-ai/flink/session-cluster/ title="Session Cluster 模式部署" class=dd-item><a href=/bigdata-ai/flink/session-cluster/>Session Cluster 模式部署
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/bigdata-ai/flink/job-cluster/ title="Job Cluster 模式部署" class=dd-item><a href=/bigdata-ai/flink/job-cluster/>Job Cluster 模式部署
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/bigdata-ai/flink/native-kubernetes/ title="Native Kubernetes 模式部署" class=dd-item><a href=/bigdata-ai/flink/native-kubernetes/>Native Kubernetes 模式部署
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/bigdata-ai/flink/ title="Flink on TKE/EKS" class=dd-item><a href=/bigdata-ai/flink/>Flink on TKE/EKS
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/bigdata-ai/spark/ title="Spark on TKE/EKS" class=dd-item><a href=/bigdata-ai/spark/>Spark on TKE/EKS
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/bigdata-ai/tensorflow/ title="TensorFlow on TKE/EKS" class="dd-item active"><a href=/bigdata-ai/tensorflow/>TensorFlow on TKE/EKS
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/faq/ title=FAQ class=dd-item><a href=/faq/>FAQ
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/faq/eks/ title="EKS 常见问题" class=dd-item><a href=/faq/eks/>EKS 常见问题
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/faq/tke/ title="TKE 常见问题" class=dd-item><a href=/faq/tke/>TKE 常见问题
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/faq/registry/ title=镜像仓库常见问题 class=dd-item><a href=/faq/registry/>镜像仓库常见问题
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/serverless/ title=Serverless class=dd-item><a href=/serverless/>Serverless
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/mesh/ title="Servie Mesh" class=dd-item><a href=/mesh/>Servie Mesh
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/containerization/ title=业务容器化 class=dd-item><a href=/containerization/>业务容器化
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/containerization/source-ip/ title="获取源 IP" class=dd-item><a href=/containerization/source-ip/>获取源 IP
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/containerization/fixed-ip/ title="固定 IP" class=dd-item><a href=/containerization/fixed-ip/>固定 IP
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/containerization/srpingcloud/ title="Spring Cloud" class=dd-item><a href=/containerization/srpingcloud/>Spring Cloud
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/containerization/dubbo/ title=Dubbo class=dd-item><a href=/containerization/dubbo/>Dubbo
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/security/ title=安全管控 class=dd-item><a href=/security/>安全管控
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/security/audit/ title=审计管理 class=dd-item><a href=/security/audit/>审计管理
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/security/app/ title=应用权限管理 class=dd-item><a href=/security/app/>应用权限管理
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/security/user/ title=用户权限管理 class=dd-item><a href=/security/user/>用户权限管理
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/damn/ title=避坑指南 class=dd-item><a href=/damn/>避坑指南
<i class="fas fa-check read-icon"></i></a></li></ul><section id=prefooter><hr><ul><li><a class=padding><i class="fas fa-language fa-fw"></i><div class=select-style><select id=select-language onchange="location=this.value;">
<option id=zh value=https://book.kubetencent.io/bigdata-ai/tensorflow/ selected>简体中文</option></select><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><polygon points="0,63.75 127.5,191.25 255,63.75" /></g></g></svg></div></a></li><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i>清理历史记录</a></li></ul></section><section id=footer><center><a class=github-button href=https://github.com/TencentCloudContainerTeam/book data-icon=octicon-star data-show-count=true aria-label="Star imroc/kubernetes-practice-guide on GitHub">Star</a>
<a class=github-button href=https://github.com/TencentCloudContainerTeam/book/fork data-icon=octicon-repo-forked data-show-count=true aria-label="Fork TencentCloudContainerTeam/book on GitHub">Fork</a></center>
<script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title=编辑当前页 href=https://github.com/TencentCloudContainerTeam/book/edit/master/content/zh/bigdata-ai/tensorflow.md target=blank><i class="fas fa-code-branch"></i><span id=top-github-link-text>编辑当前页</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/>腾讯云容器服务指南</a> > <a href=/bigdata-ai/>大数据与 AI</a> > TensorFlow on TKE/EKS</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#安装部署>安装部署</a><ul><li><a href=#安装-kubeflow>安装 kubeflow</a></li><li><a href=#安装-tf-operator>安装 tf-operator</a></li><li><a href=#测试>测试</a></li></ul></li><li><a href=#使用kube-batch调度器>使用kube-batch调度器</a><ul><li><a href=#部署kube-batch>部署kube-batch</a></li><li><a href=#修改tf-operator>修改tf-operator</a></li><li><a href=#测试-1>测试</a></li></ul></li><li><a href=#使用volcano调度器>使用volcano调度器</a><ul><li><a href=#部署>部署</a></li><li><a href=#修改tf-operator启用volcano调度器>修改tf-operator启用volcano调度器</a></li><li><a href=#测试-2>测试</a></li><li><a href=#直接使用volcano进行训练>直接使用volcano进行训练</a></li></ul></li><li><a href=#tf-operator-on-eks>tf-operator on EKS</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>TensorFlow on TKE/EKS</h1><div class="notices info"><p>文档当前状态：Alpha</p></div><h2 id=简介>简介</h2><p>Kubeflow 开始是从支持tensorflow分布式训练演化而来，现在已经是一个由众多子项目组成的开源产品，愿景是在 Kubernetes 上运行各种机器学习工作负载， 包括tensorflow,pytorch等主流计算引擎，面向机器学习场景的工作流引擎argo等。支持从模型开发，模型训练到最终服务部署的全链条工具。采用tf-operator进行分布式tf训练可以方便提交任务，具有重试，容错等优势</p><h2 id=安装部署>安装部署</h2><h3 id=安装-kubeflow>安装 kubeflow</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -sL https://github.com/kubeflow/kfctl/releases/download/v1.0/kfctl_v1.0-0-g94c35cf_linux.tar.gz | tar -xzvf -C /home/ubuntu/kubeflow
export PATH<span style=color:#f92672>=</span>$PATH:/home/ubuntu/kubeflow
export KF_NAME<span style=color:#f92672>=</span>my-kubeflow
export BASE_DIR<span style=color:#f92672>=</span>/home/ubuntu/kubeflow
export KF_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>BASE_DIR<span style=color:#e6db74>}</span>/<span style=color:#e6db74>${</span>KF_NAME<span style=color:#e6db74>}</span>
export CONFIG_URI<span style=color:#f92672>=</span>https://raw.githubusercontent.com/kubeflow/manifests/v1.0-branch/kfdef/kfctl_k8s_istio.v1.0.0.yaml
kfctl build -V -f <span style=color:#66d9ef>$(</span>CONFIG_URI<span style=color:#66d9ef>)</span>
</code></pre></div><h3 id=安装-tf-operator>安装 tf-operator</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kustomize build my-kubeflow/kustomize/tf-job-crds/overlays/application | kubectl create –f -
kustomize build my-kubeflow/kustomize/tf-job-operator/overlays/application | kubectl create –f
</code></pre></div><h3 id=测试>测试</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git clone https://github.com/tensorflow/k8s.git
kubectl create –f k8s/examples/v1/dist-mnist/tf_job_mnist.yaml
</code></pre></div><h2 id=使用kube-batch调度器>使用kube-batch调度器</h2><p>k8s缺省的调度器以pod为单位进行调度,也不提供按训练任务优先级优先级进行整体调度的功能，但是分布式机器学习会同时启动多种task，比如PS,WORKER，而且每种task都会有多个副本，这样有可能出现一个任务的部分pod被创建，而其他pod处于pending状态，出现资源被占用但是训练任务不能被启动执行的状态。kube-batch就是解决这种问题的批调度器，另外也提供队列和资源公平调度drf等功能。</p><h3 id=部署kube-batch>部署kube-batch</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git clone http://github.com/kubernetes-sigs/kube-batch
cd kube-batch/deployment/kube-batch
helm install --name kube-batch --namespace kube-system
</code></pre></div><p>缺省安装后kube-batch缺乏必要的权限来lw集群资源，需要额外创建RBAC，添加对应serviceaccount的cluster-admin权限用于lw集群中的node, pod等对象来维护自身的资源视图</p><h3 id=修改tf-operator>修改tf-operator</h3><p>启动参数添加enable-gang-scheduling=true</p><p>tf-operator缺省使用volcano调度器，添加启动参数gang-scheduler-name=kube-batch, （或者在TFJOB的申请中指定调度器名）</p><p>修改RBAC添加tf-operator serviceaccount访问podgroups资源的权限</p><h3 id=测试-1>测试</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: scheduling.incubator.k8s.io/v1alpha1
<span style=color:#66d9ef>kind</span>: PodGroup
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: tfjob-group
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>minMember</span>: <span style=color:#ae81ff>6</span>
 
---
 
<span style=color:#66d9ef>apiVersion</span>: <span style=color:#e6db74>&#34;kubeflow.org/v1&#34;</span>
<span style=color:#66d9ef>kind</span>: <span style=color:#e6db74>&#34;TFJob&#34;</span>
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: <span style=color:#e6db74>&#34;dist-mnist-for-e2e-test&#34;</span>
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>tfReplicaSpecs</span>:
    <span style=color:#66d9ef>PS</span>:
      <span style=color:#66d9ef>replicas</span>: <span style=color:#ae81ff>2</span>
      <span style=color:#66d9ef>restartPolicy</span>: Never
      <span style=color:#66d9ef>template</span>:
        <span style=color:#66d9ef>metadata</span>:
          <span style=color:#66d9ef>annotations</span>:
            <span style=color:#66d9ef>scheduling.k8s.io/group-name</span>: tfjob-group
        <span style=color:#66d9ef>spec</span>:
          <span style=color:#66d9ef>schedulerName</span>: kube-batch
          <span style=color:#66d9ef>containers</span>:
            - <span style=color:#66d9ef>name</span>: tensorflow
              <span style=color:#66d9ef>image</span>: ccr.ccs.tencentyun.com/chenyong/tf-dist-mnist-test:<span style=color:#ae81ff>1.0</span>
    <span style=color:#66d9ef>Worker</span>:
      <span style=color:#66d9ef>replicas</span>: <span style=color:#ae81ff>4</span>
      <span style=color:#66d9ef>restartPolicy</span>: Never
      <span style=color:#66d9ef>template</span>:
        <span style=color:#66d9ef>metadata</span>:
          <span style=color:#66d9ef>annotations</span>:
            <span style=color:#66d9ef>scheduling.k8s.io/group-name</span>: tfjob-group
        <span style=color:#66d9ef>spec</span>:
          <span style=color:#66d9ef>schedulerName</span>: kube-batch
          <span style=color:#66d9ef>containers</span>:
            - <span style=color:#66d9ef>name</span>: tensorflow
              <span style=color:#66d9ef>image</span>: ccr.ccs.tencentyun.com/chenyong/tf-dist-mnist-test:<span style=color:#ae81ff>1.0</span>
</code></pre></div><h2 id=使用volcano调度器>使用volcano调度器</h2><h3 id=部署>部署</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f https://raw.githubusercontent.com/volcano-sh/volcano/master/installer/volcano-development.yaml
</code></pre></div><h3 id=修改tf-operator启用volcano调度器>修改tf-operator启用volcano调度器</h3><p>tf-operator缺省使用volcano，只要添加enable-gang-scheduling=true启动参数就可以，非常方便</p><h3 id=测试-2>测试</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: scheduling.volcano.sh/v1beta1
<span style=color:#66d9ef>kind</span>: PodGroup
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: dist-mnist-for-e2e-test
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>minMember</span>: <span style=color:#ae81ff>6</span>
---
<span style=color:#66d9ef>apiVersion</span>: <span style=color:#e6db74>&#34;kubeflow.org/v1&#34;</span>
<span style=color:#66d9ef>kind</span>: <span style=color:#e6db74>&#34;TFJob&#34;</span>
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: <span style=color:#e6db74>&#34;dist-mnist-for-e2e-test&#34;</span>
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>tfReplicaSpecs</span>:
    <span style=color:#66d9ef>PS</span>:
      <span style=color:#66d9ef>replicas</span>: <span style=color:#ae81ff>2</span>
      <span style=color:#66d9ef>restartPolicy</span>: Never
      <span style=color:#66d9ef>template</span>:
        <span style=color:#66d9ef>spec</span>:
          <span style=color:#66d9ef>containers</span>:
            - <span style=color:#66d9ef>name</span>: tensorflow
              <span style=color:#66d9ef>image</span>: ccr.ccs.tencentyun.com/chenyong/tf-dist-mnist-test:<span style=color:#ae81ff>1.0</span>
    <span style=color:#66d9ef>Worker</span>:
      <span style=color:#66d9ef>replicas</span>: <span style=color:#ae81ff>4</span>
      <span style=color:#66d9ef>restartPolicy</span>: Never
      <span style=color:#66d9ef>template</span>:
        <span style=color:#66d9ef>spec</span>:
          <span style=color:#66d9ef>containers</span>:
            - <span style=color:#66d9ef>name</span>: tensorflow
              <span style=color:#66d9ef>image</span>: ccr.ccs.tencentyun.com/chenyong/tf-dist-mnist-test:<span style=color:#ae81ff>1.0</span>
</code></pre></div><h3 id=直接使用volcano进行训练>直接使用volcano进行训练</h3><p>volcano除了包含批调度器外，还实现了一组CRD和controller， 通过创建CRD就可以直接启动分布式tensorflow的训练任务</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: batch.volcano.sh/v1alpha1
<span style=color:#66d9ef>kind</span>: Job
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: tensorflow-dist-mnist
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>minAvailable</span>: <span style=color:#ae81ff>3</span>
  <span style=color:#66d9ef>schedulerName</span>: volcano
  <span style=color:#66d9ef>plugins</span>:
    <span style=color:#66d9ef>env</span>: []
    <span style=color:#66d9ef>svc</span>: []
  <span style=color:#66d9ef>policies</span>:
    - <span style=color:#66d9ef>event</span>: PodEvicted
      <span style=color:#66d9ef>action</span>: RestartJob
  <span style=color:#66d9ef>tasks</span>:
    - <span style=color:#66d9ef>replicas</span>: <span style=color:#ae81ff>1</span>
      <span style=color:#66d9ef>name</span>: ps
      <span style=color:#66d9ef>template</span>:
        <span style=color:#66d9ef>spec</span>:
          <span style=color:#66d9ef>containers</span>:
            - <span style=color:#66d9ef>command</span>:
                - sh
                - -c
                - <span style=color:#e6db74>|
</span><span style=color:#e6db74>                  PS_HOST=`cat /etc/volcano/ps.host | sed &#39;s/$/&amp;:2222/g&#39; | sed &#39;s/^/&#34;/;s/$/&#34;/&#39; | tr &#34;\n&#34; &#34;,&#34;`;</span>
                  WORKER_HOST=`cat /etc/volcano/worker.host | sed <span style=color:#e6db74>&#39;s/$/&amp;:2222/g&#39;</span> | sed <span style=color:#e6db74>&#39;s/^/&#34;/;s/$/&#34;/&#39;</span> | tr <span style=color:#e6db74>&#34;\n&#34;</span> <span style=color:#e6db74>&#34;,&#34;</span>`;
                  export TF_CONFIG={\<span style=color:#e6db74>&#34;cluster\&#34;:{\&#34;ps\&#34;:[${PS_HOST}],\&#34;worker\&#34;:[${WORKER_HOST}]},\&#34;task\&#34;:{\&#34;type\&#34;:\&#34;ps\&#34;,\&#34;index\&#34;:${VK_TASK_INDEX}},\&#34;environment\&#34;:\&#34;cloud\&#34;};
</span><span style=color:#e6db74>                  python /var/tf_dist_mnist/dist_mnist.py
</span><span style=color:#e6db74>              image: volcanosh/dist-mnist-tf-example:0.0.1
</span><span style=color:#e6db74>              name: tensorflow
</span><span style=color:#e6db74>              ports:
</span><span style=color:#e6db74>                - containerPort: 2222
</span><span style=color:#e6db74>                  name: tfjob-port
</span><span style=color:#e6db74>              resources: {}
</span><span style=color:#e6db74>          restartPolicy: Never
</span><span style=color:#e6db74>    - replicas: 2
</span><span style=color:#e6db74>      name: worker
</span><span style=color:#e6db74>      policies:
</span><span style=color:#e6db74>        - event: TaskCompleted
</span><span style=color:#e6db74>          action: CompleteJob
</span><span style=color:#e6db74>      template:
</span><span style=color:#e6db74>        spec:
</span><span style=color:#e6db74>          containers:
</span><span style=color:#e6db74>            - command:
</span><span style=color:#e6db74>                - sh
</span><span style=color:#e6db74>                - -c
</span><span style=color:#e6db74>                - |
</span><span style=color:#e6db74>                  PS_HOST=`cat /etc/volcano/ps.host | sed &#39;s/$/&amp;:2222/g&#39; | sed &#39;s/^/&#34;</span>/;s/$/<span style=color:#e6db74>&#34;/&#39; | tr &#34;</span>\n<span style=color:#e6db74>&#34; &#34;</span>,<span style=color:#e6db74>&#34;`;
</span><span style=color:#e6db74>                  WORKER_HOST=`cat /etc/volcano/worker.host | sed &#39;s/$/&amp;:2222/g&#39; | sed &#39;s/^/&#34;</span>/;s/$/<span style=color:#e6db74>&#34;/&#39; | tr &#34;</span>\n<span style=color:#e6db74>&#34; &#34;</span>,<span style=color:#e6db74>&#34;`;
</span><span style=color:#e6db74>                  export TF_CONFIG={\&#34;cluster\&#34;:{\&#34;ps\&#34;:[${PS_HOST}],\&#34;worker\&#34;:[${WORKER_HOST}]},\&#34;task\&#34;:{\&#34;type\&#34;:\&#34;worker\&#34;,\&#34;index\&#34;:${VK_TASK_INDEX}},\&#34;environment\&#34;:\&#34;cloud\&#34;</span>};
                  python /var/tf_dist_mnist/dist_mnist.py
              <span style=color:#66d9ef>image</span>: volcanosh/dist-mnist-tf-example:<span style=color:#ae81ff>0.0.1</span>
              <span style=color:#66d9ef>name</span>: tensorflow
              <span style=color:#66d9ef>ports</span>:
                - <span style=color:#66d9ef>containerPort</span>: <span style=color:#ae81ff>2222</span>
                  <span style=color:#66d9ef>name</span>: tfjob-port
              <span style=color:#66d9ef>resources</span>: {}
          <span style=color:#66d9ef>restartPolicy</span>: Never
</code></pre></div><h2 id=tf-operator-on-eks>tf-operator on EKS</h2><p>tf-operator也可以在eks平台上部署和调度任务，但是目前还不支持扩展调度器，如果eks资源池足够大，不会出现部分pod被调度的情况</p><footer class=footline></footer></div><div id=gitalk-container></div><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><script>console.log("gitalk id:e53c6a6474068c301f10dbb5f6ba2bda")
var gitalk=new Gitalk({clientID:'4e9444088ec088b58f37',clientSecret:'b8faa4be9753a13d0b01ccdf4ccc015f9983b58c',repo:'book',owner:'TencentCloudContainerTeam',admin:["imroc","coderwangke","willbern"],labels:['Gitalk'],title:'TensorFlow on TKE\/EKS',createIssueManually:false,id:'e53c6a6474068c301f10dbb5f6ba2bda',distractionFreeMode:true});gitalk.render('gitalk-container');</script></div><div id=navigation><a class="nav nav-prev" href=/bigdata-ai/spark/ title="Spark on TKE/EKS"><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=/faq/ title=FAQ style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div></body></html>